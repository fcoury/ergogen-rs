# ergogen-rs

Rust implementation of **Ergogen** (_Ergonomic Keyboard Generator_), compatible with the upstream YAML format and focused on:

- Deterministic, testable output generation (SVG/DXF/KiCad/JSCAD)
- JS footprint support (including upstream footprint libraries)
- A WASM build that powers the GUI runtime

This repo is not (yet) a drop‑in replacement for upstream Ergogen in every scenario, but it aims for parity via fixtures, goldens, and upstream baseline comparisons.

## Status

- **WASM runtime**: integrated into the GUI worker; renders built‑in examples (e.g. Absolem) with matching visuals against upstream deployments.
- **Exports**:
  - Outlines → DXF + SVG
  - PCBs → KiCad `.kicad_pcb`
  - Cases → JSCAD (currently v1 CSG, to stay compatible with the UI’s OpenJSCAD converter)
- **CLI**: currently minimal (includes `dxf2png` for DXF comparisons); “full CLI parity” is still in progress.

## Related Repos (optional)

Depending on how you work, you may also have:

- A GUI repo that consumes `ergogen-wasm`
- A local clone of upstream Ergogen (useful for generating baselines and parity checks)

## Quick Start

### Prerequisites

- Rust toolchain (stable recommended)
- For WASM builds: `rustup target add wasm32-unknown-unknown`
- For building `ergogen-wasm` bundles: `wasm-bindgen-cli` (install with `cargo install wasm-bindgen-cli` if needed)

### Build / test

```bash
cargo fmt --all
cargo check
cargo clippy
cargo test
```

## CLI

Current CLI surface area (WIP):

```bash
cargo run -p ergogen-cli -- --help
```

DXF → PNG helper (useful for debugging outline diffs in CI):

```bash
cargo run -p ergogen-cli -- dxf2png path/to/file.dxf
```

## WASM

The `ergogen-wasm` crate provides the WASM entry points used by the GUI:

- `render_all(yaml) -> { canonical, points, units, demo, outlines, pcbs, cases, errors }`
- `render_dxf(yaml, outline_name)`
- `render_svg(yaml, outline_name)`
- `render_pcb(yaml, pcb_name)`

Build the WASM artifact:

```bash
cargo build -p ergogen-wasm --release --target wasm32-unknown-unknown
```

## Compatibility Notes

Upstream configs sometimes rely on YAML constructs that `serde_yaml` rejects.
We normalize a few of these in the parser so existing configs keep working:

- Flow sequence “holes”: `[, 10, ,]` → `null` items
- Flow sequences containing expressions: `[-ks * 0.5, kp * 0.25]` → quoted strings

If you find another real‑world config that parses in upstream Ergogen but fails here, please open an issue (or add a fixture).

## Testing, Goldens, and Upstream Baselines

This repo uses two kinds of snapshot inputs/outputs:

- **Goldens**: outputs generated by our Rust tool, committed as fixtures.
- **Upstream baselines**: outputs generated by JS Ergogen at a pinned version/commit.

To refresh upstream baselines:

```bash
./scripts/update-upstream-baselines.sh <commit> <fixture-yaml> [fixture-name]
```

Use:

- `ERGOGEN_UPSTREAM_DIR` to point at a local upstream clone (for pinned commits)
- `ERGOGEN_UPSTREAM_CMD` to override the CLI used to generate upstream outputs
- `UPSTREAM_BASELINE_DIR` to compare tests against a chosen baseline directory

## CI: Upstream JS Footprint Parity

We run a small JS footprint parity check against upstream Ergogen in CI to catch regressions:

- Workflow: `/.github/workflows/js-footprints-upstream.yml`
- Generates upstream outputs via `npx ergogen@4.1.0`
- Runs the env‑gated test `js_footprints_upstream` against those outputs

There’s a provision to gate this job on a PR label (e.g. `run-upstream-js`), but it’s currently commented out in the workflow until we measure stability/latency. Uncomment the job‑level `if:` line in that workflow to enable label‑based gating.

## Crate Map

- `crates/ergogen-parser`: YAML + templating + unit expression evaluation
- `crates/ergogen-layout`: points/zones layout generation
- `crates/ergogen-outline`: outline generation (regions, hulls, Maker.js paths)
- `crates/ergogen-export`: exporters (DXF/SVG/JSCAD) + reference output tests
- `crates/ergogen-pcb`: KiCad PCB generation + footprint runtime/parity tests
- `crates/ergogen-wasm`: WASM bindings for use in the GUI
- `crates/ergogen-cli`: CLI entry point (currently includes `dxf2png`)

## Attribution

This is a Rust port of upstream Ergogen. See the upstream project for docs and community links:
https://github.com/ergogen/ergogen
